<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin Dashboard - DJ Request System</title>
    <link rel="stylesheet" href="admin/styles.css">
    <style>
        .admin-panel {
            padding: 30px;
            background-color: #1e1e1e;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .users-table th, .users-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        .users-table th {
            background-color: rgba(138, 43, 226, 0.2);
        }
        .status-inactive {
            color: #ff6b6b;
        }
        .status-active {
            color: #4caf50;
        }
        .role-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .role-admin {
            background-color: #8a2be2;
        }
        .role-pro {
            background-color: #2e8b57;
        }
        .role-basic {
            background-color: #4169e1;
        }
        .action-button {
            padding: 6px 10px;
            font-size: 14px;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
        }

        select {
            width: 100%;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-color);
            font-size: 16px;
        }

        input[type="date"] {
            width: 100%;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-color);
            font-size: 16px;
        }

        .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="admin-panel">
            <h1>Super Admin Dashboard</h1>
            <h2>User Management</h2>
            
            <div id="usersList">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Subscription End</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="6">Loading users...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Logout Button -->
        <button id="logoutButton" style="position: fixed; top: 20px; right: 20px;">Logout</button>

        <div id="editUserModal" class="modal" style="display: none;">
            <div class="modal-content">
                <h3>Edit User</h3>
                <div id="editForm">
                    <input type="hidden" id="editUserId">
                    <input type="hidden" id="editAuthId">
                    
                    <div class="form-group">
                        <label for="editName">Name</label>
                        <input type="text" id="editName">
                    </div>
                    
                    <div class="form-group">
                        <label for="editEmail">Email</label>
                        <input type="email" id="editEmail" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="editRole">Role</label>
                        <select id="editRole">
                            <option value="">Loading roles...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editStatus">Status</label>
                        <select id="editStatus">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editSubscription">Subscription End Date</label>
                        <input type="date" id="editSubscription">
                    </div>
                    
                    <div class="button-group">
                        <button id="saveUserButton">Save Changes</button>
                        <button id="cancelEditButton">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ADD to super-admin.html - Create new user modal -->
    <div id="createUserModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Create New DJ Account</h3>
            <div id="createForm">
                <div class="form-group">
                    <label for="createName">Full Name</label>
                    <input type="text" id="createName" required>
                </div>
                
                <div class="form-group">
                    <label for="createEmail">Email Address</label>
                    <input type="email" id="createEmail" required>
                </div>
                
                <div class="form-group">
                    <label for="createRole">Role</label>
                    <select id="createRole">
                        <option value="">Loading roles...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="createStatus">Status</label>
                    <select id="createStatus">
                        <option value="true">Active</option>
                        <option value="false">Inactive (Pending Approval)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="createSubscription">Subscription End Date</label>
                    <input type="date" id="createSubscription">
                </div>
                
                <div class="button-group">
                    <button id="saveNewUserButton">Create Account</button>
                    <button id="cancelCreateButton">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://ljekmnuflfotwznxeexc.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxqZWttbnVmbGZvdHd6bnhlZXhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MjU1NzksImV4cCI6MjA3NTUwMTU3OX0.S6yzIIKRv1YlKPHstMpTFqqSpAQOuFUOqC0G27zE4FE';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // Check if admin is logged in
        if (!localStorage.getItem('isLoggedIn') || localStorage.getItem('isAdmin') !== 'true') {
            window.location.href = 'admin/login.html';
        }
        
        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }
        
        // Get role badge HTML
        function getRoleBadge(roleName) {
            let className = '';
            switch (roleName) {
                case 'Admin':
                    className = 'role-admin';
                    break;
                case 'Pro DJ':
                    className = 'role-pro';
                    break;
                case 'Basic DJ':
                    className = 'role-basic';
                    break;
            }
            return `<span class="role-badge ${className}">${roleName}</span>`;
        }
        
        // Load users
        async function loadUsers() {
            try {
                console.log('Loading users...');
                
                // Get all existing dj_users records
                const { data: djUsers, error: djError } = await supabase
                    .from('dj_users')
                    .select('*, roles(name)')
                    .order('created_at', { ascending: false });
                
                if (djError) {
                    console.error("Error fetching DJ users:", djError);
                    throw djError;
                }
                
                console.log('DJ users:', djUsers ? djUsers.length : 0);
                
                const tableBody = document.getElementById('usersTableBody');
                tableBody.innerHTML = '';
                
                // If no users found
                if (!djUsers || djUsers.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6">No users found</td></tr>';
                    return;
                }
                
                // Process and display all dj users
                djUsers.forEach(user => {
                    const tr = document.createElement('tr');
                    
                    // Determine user status and role
                    const isActive = user.active;
                    const roleName = user.roles?.name || 'Not Set';
                    
                    // Create table row
                    tr.innerHTML = `
                        <td>${user.name || 'N/A'}</td>
                        <td>${user.email || 'N/A'}</td>
                        <td>${getRoleBadge(roleName)}</td>
                        <td class="${isActive ? 'status-active' : 'status-inactive'}">${isActive ? 'Active' : 'Inactive'}</td>
                        <td>${formatDate(user.subscription_ends)}</td>
                        <td>
                            ${!isActive ? `<button class="action-button" data-action="activate" data-id="${user.id}">Activate</button>` : ''}
                            <button class="action-button" data-action="edit" data-id="${user.id}">Edit</button>
                        </td>
                    `;
                    
                    tableBody.appendChild(tr);
                });
                
                // Add event listeners for action buttons
                document.querySelectorAll('[data-action="activate"]').forEach(button => {
                    button.addEventListener('click', () => activateUser(button.getAttribute('data-id')));
                });
                
                document.querySelectorAll('[data-action="edit"]').forEach(button => {
                    button.addEventListener('click', () => editUser(button.getAttribute('data-id')));
                });
                
                // Add a "Create New User" button above the table
                const tableContainer = document.getElementById('usersList');
                
                if (!document.getElementById('createUserButton')) {
                    const createButtonContainer = document.createElement('div');
                    createButtonContainer.style.marginBottom = '20px';
                    createButtonContainer.innerHTML = `
                        <button id="createUserButton" class="action-button" style="padding: 10px 20px; background-color: #4caf50;">
                            Create New DJ Account
                        </button>
                    `;
                    
                    tableContainer.insertBefore(createButtonContainer, tableContainer.firstChild);
                    
                    // Add event listener for create button
                    document.getElementById('createUserButton').addEventListener('click', () => {
                        openCreateUserModal();
                    });
                }
                
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersTableBody').innerHTML = `<tr><td colspan="6">Error loading users: ${error.message}</td></tr>`;
            }
        }

        // ADD to super-admin.html - Function to create a new DJ user
        async function createDjUser(authId, email, name) {
            try {
                // Open the edit user modal with creation mode
                await openEditUserModal(null, true, { authId, email, name });
            } catch (error) {
                console.error('Error creating DJ user:', error);
                alert('Failed to create DJ user: ' + error.message);
            }
        }
        
        // Activate user
        async function activateUser(userId) {
            try {
                // Log the activation attempt
                console.log('Activating user:', userId);
                
                // Update the user in the database
                const { error } = await supabase
                    .from('dj_users')
                    .update({ active: true })
                    .eq('id', userId);
                
                if (error) {
                    throw error;
                }
                
                // Show success message
                alert('User activated successfully!');
                
                // Find the row in the table and update it visually
                const userRow = document.querySelector(`button[data-action="activate"][data-id="${userId}"]`).closest('tr');
                const statusCell = userRow.querySelector('td:nth-child(4)'); // The status column
                
                // Update the status cell
                statusCell.className = 'status-active';
                statusCell.textContent = 'Active';
                
                // Remove the activate button
                userRow.querySelector('button[data-action="activate"]').remove();
                
                // Refresh the list to ensure everything is in sync
                setTimeout(loadUsers, 1000); // Reload after a short delay
                
            } catch (error) {
                console.error('Error activating user:', error);
                alert('Failed to activate user: ' + error.message);
            }
        }
        
        // Edit user (placeholder for now)
        function editUser(userId) {
            openEditUserModal(userId);
        }

        // Open the edit user modal
        function openEditUserModal(userId) {
            editUser(userId);
        }
        
        // Logout
        document.getElementById('logoutButton').addEventListener('click', function() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('userEmail');
            window.location.href = 'admin/login.html';
        });
        
        // Load users when page loads
        document.addEventListener('DOMContentLoaded', loadUsers);

        // Load roles for select dropdown
        async function loadRoles() {
            try {
                const { data: roles, error } = await supabase
                    .from('roles')
                    .select('*');
                
                if (error) throw error;
                
                const roleSelect = document.getElementById('editRole');
                roleSelect.innerHTML = '';
                
                if (roles && roles.length > 0) {
                    roles.forEach(role => {
                        const option = document.createElement('option');
                        option.value = role.id;
                        option.textContent = role.name;
                        roleSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading roles:', error);
            }
        }

        // Open edit user modal
        async function openEditUserModal(userId, isNew = false, newUserData = null) {
            try {
                // Load roles for dropdown
                await loadRoles();
                
                // If this is a new user (creating DJ user for existing Auth user)
                if (isNew && newUserData) {
                    document.getElementById('editUserId').value = '';
                    document.getElementById('editAuthId').value = newUserData.authId;
                    document.getElementById('editName').value = newUserData.name || '';
                    document.getElementById('editEmail').value = newUserData.email || '';
                    document.getElementById('editStatus').value = 'false'; // Inactive by default
                    
                    // Set default role to Basic DJ
                    const basicDjOption = Array.from(document.getElementById('editRole').options)
                        .find(option => option.text === 'Basic DJ');
                        
                    if (basicDjOption) {
                        document.getElementById('editRole').value = basicDjOption.value;
                    }
                    
                    // Default to 30 days subscription
                    const date = new Date();
                    date.setMonth(date.getMonth() + 1);
                    document.getElementById('editSubscription').value = date.toISOString().split('T')[0];
                    
                    // Update modal title
                    document.querySelector('#editUserModal h3').textContent = 'Create DJ User';
                    
                    // Show modal
                    document.getElementById('editUserModal').style.display = 'flex';
                    return;
                }
                
                // For existing users, get their details
                const { data: user, error } = await supabase
                    .from('dj_users')
                    .select('*, roles(id, name)')
                    .eq('id', userId)
                    .single();
                
                if (error) throw error;
                
                // Populate form
                document.getElementById('editUserId').value = user.id;
                document.getElementById('editAuthId').value = user.auth_id;
                document.getElementById('editName').value = user.name || '';
                document.getElementById('editEmail').value = user.email || '';
                document.getElementById('editStatus').value = user.active.toString();
                
                if (user.role_id) {
                    document.getElementById('editRole').value = user.role_id;
                }
                
                // Format date for input
                if (user.subscription_ends) {
                    const date = new Date(user.subscription_ends);
                    const formattedDate = date.toISOString().split('T')[0]; // Format as YYYY-MM-DD
                    document.getElementById('editSubscription').value = formattedDate;
                } else {
                    // Default to 1 month from now
                    const date = new Date();
                    date.setMonth(date.getMonth() + 1);
                    document.getElementById('editSubscription').value = date.toISOString().split('T')[0];
                }
                
                // Update modal title
                document.querySelector('#editUserModal h3').textContent = 'Edit User';
                
                // Show modal
                document.getElementById('editUserModal').style.display = 'flex';
                
            } catch (error) {
                console.error('Error opening edit form:', error);
                alert('Failed to load user details: ' + error.message);
            }
        }

        // Save user changes
        async function saveUserChanges() {
            try {
                const userId = document.getElementById('editUserId').value;
                const authId = document.getElementById('editAuthId').value;
                const name = document.getElementById('editName').value;
                const email = document.getElementById('editEmail').value;
                const roleId = document.getElementById('editRole').value;
                const active = document.getElementById('editStatus').value === 'true';
                const subscriptionEnd = document.getElementById('editSubscription').value;
                
                // Create subscription date
                const subscriptionDate = new Date(subscriptionEnd);
                
                // Check if this is a new user (creating) or existing (updating)
                if (!userId) {
                    // Creating a new DJ user for an existing Auth user
                    const { data, error } = await supabase
                        .from('dj_users')
                        .insert([{
                            auth_id: authId,
                            name: name,
                            email: email,
                            role_id: roleId,
                            active: active,
                            subscription_ends: subscriptionDate.toISOString()
                        }]);
                    
                    if (error) throw error;
                    
                    alert('DJ user account created successfully!');
                } else {
                    // Updating an existing user
                    const { error } = await supabase
                        .from('dj_users')
                        .update({
                            name: name,
                            role_id: roleId,
                            active: active,
                            subscription_ends: subscriptionDate.toISOString()
                        })
                        .eq('id', userId);
                    
                    if (error) throw error;
                    
                    alert('User updated successfully!');
                }
                
                document.getElementById('editUserModal').style.display = 'none';
                loadUsers(); // Refresh the list
                
            } catch (error) {
                console.error('Error saving user changes:', error);
                alert('Failed to update user: ' + error.message);
            }
        }

        // ADD to super-admin.html - Functions for creating new users
        function openCreateUserModal() {
            // Load roles for dropdown
            loadRoles('createRole');
            
            // Default values
            document.getElementById('createName').value = '';
            document.getElementById('createEmail').value = '';
            document.getElementById('createStatus').value = 'false'; // Inactive by default
            
            // Default subscription to 30 days from now
            const date = new Date();
            date.setMonth(date.getMonth() + 1);
            document.getElementById('createSubscription').value = date.toISOString().split('T')[0];
            
            // Show modal
            document.getElementById('createUserModal').style.display = 'flex';
        }

        // Updated loadRoles function to work with different select elements
        async function loadRoles(selectId = 'editRole') {
            try {
                const { data: roles, error } = await supabase
                    .from('roles')
                    .select('*');
                
                if (error) throw error;
                
                const roleSelect = document.getElementById(selectId);
                roleSelect.innerHTML = '';
                
                if (roles && roles.length > 0) {
                    roles.forEach(role => {
                        const option = document.createElement('option');
                        option.value = role.id;
                        option.textContent = role.name;
                        roleSelect.appendChild(option);
                    });
                    
                    // Default to Basic DJ
                    const basicDjOption = Array.from(roleSelect.options)
                        .find(option => option.text === 'Basic DJ');
                        
                    if (basicDjOption) {
                        roleSelect.value = basicDjOption.value;
                    }
                }
            } catch (error) {
                console.error('Error loading roles:', error);
            }
        }

        async function createNewUser() {
            try {
                const name = document.getElementById('createName').value;
                const email = document.getElementById('createEmail').value;
                const roleId = document.getElementById('createRole').value;
                const active = document.getElementById('createStatus').value === 'true';
                const subscriptionEnd = document.getElementById('createSubscription').value;
                
                if (!name || !email || !roleId) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                // Create subscription date
                const subscriptionDate = new Date(subscriptionEnd);
                
                // Check if user with this email already exists
                const { data: existingUsers, error: checkError } = await supabase
                    .from('dj_users')
                    .select('id')
                    .eq('email', email);
                    
                if (checkError) throw checkError;
                
                if (existingUsers && existingUsers.length > 0) {
                    alert('A user with this email already exists');
                    return;
                }
                
                // Create a new auth user in Supabase to get auth_id
                // Note: This uses passwordless login since we're creating from admin side
                const tempPassword = Math.random().toString(36).slice(-8);
                const { data: authUser, error: authError } = await supabase.auth.admin.createUser({
                    email: email,
                    password: tempPassword,
                    email_confirm: true
                });
                
                if (authError) {
                    // If we can't create auth user (need service role), we can still create dj_user
                    console.warn("Could not create auth user:", authError);
                    console.warn("Creating dj_user without auth_id - user will need to register");
                    
                    // Create dj_user without auth_id
                    const { error: insertError } = await supabase
                        .from('dj_users')
                        .insert([{
                            name: name,
                            email: email,
                            role_id: roleId,
                            active: active,
                            subscription_ends: subscriptionDate.toISOString()
                        }]);
                        
                    if (insertError) throw insertError;
                    
                    alert('DJ User created successfully! The user will need to register to link their account.');
                } else {
                    // We were able to create auth user, now create dj_user with auth_id
                    const auth_id = authUser.user.id;
                    
                    const { error: insertError } = await supabase
                        .from('dj_users')
                        .insert([{
                            auth_id: auth_id,
                            name: name,
                            email: email,
                            role_id: roleId,
                            active: active,
                            subscription_ends: subscriptionDate.toISOString()
                        }]);
                        
                    if (insertError) throw insertError;
                    
                    alert('DJ User created successfully with linked Auth account!');
                }
                
                // Close modal and reload users
                document.getElementById('createUserModal').style.display = 'none';
                loadUsers();
                
            } catch (error) {
                console.error('Error creating user:', error);
                alert('Failed to create user: ' + error.message);
            }
        }

        function closeCreateModal() {
            document.getElementById('createUserModal').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('saveUserButton').addEventListener('click', saveUserChanges);
            document.getElementById('cancelEditButton').addEventListener('click', closeEditModal);
            
            // Add listeners for create user modal
            document.getElementById('saveNewUserButton').addEventListener('click', createNewUser);
            document.getElementById('cancelCreateButton').addEventListener('click', closeCreateModal);
        });
    </script>
</body>
</html>